<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8" />
		<title>听指令的小方块</title>
		<link rel="stylesheet" type="text/css" href="css/box.css" />
	</head>

	<body onload="load()">
		<div class="g-pnl">
			<p class="title">听指令的小方块3</p>
			<div class="left-pnl">
				<ul class="x-coordinate">
					<li>1</li>
					<li>2</li>
					<li>3</li>
					<li>4</li>
					<li>5</li>
					<li>6</li>
					<li>7</li>
					<li>8</li>
					<li>9</li>
					<li>10</li>
				</ul>
				<ul class="y-coordinate">
					<li>1</li>
					<li>2</li>
					<li>3</li>
					<li>4</li>
					<li>5</li>
					<li>6</li>
					<li>7</li>
					<li>8</li>
					<li>9</li>
					<li>10</li>
				</ul>
				<div class="floor">
					<div class="box" id="box"></div>
				</div>
			</div>
			<div class="right-pnl ctrl-pnl">
				<!--<input type="text" id="input" />-->
				<div class="btn-pnl">
					<button type="button" id="refresh">刷新</button>
					<button type="button" id="submit">执行</button>
				</div>
				<div class="code-pnl">
					<ul>
						<li>1</li>
					</ul>
					<textarea id="input"></textarea>
				</div>
			</div>
		</div>
	</body>

	<script>
		function load() {
			var input = document.querySelector("#input");
			var box = {
				el: document.querySelector("#box"),
				rotate: 0, // 旋转角度
				direction: 0, // 方向  | 0: 上 | 1: 右 | 2: 下 | 3: 左 |
				timer: "",
				animateFlag: false
			}
			var ctrl = {
				"init": function() {
					var submit = document.querySelector("#submit");
					var refresh = document.querySelector("#refresh");

					input.addEventListener('input', function() {
						ctrl.onInputValueChange()
					});

					// 转换大小写
					input.addEventListener('keyup', function(e) {
						this.value = this.value.toLocaleUpperCase();
					});

					input.addEventListener('scroll', function(e) {
						var ul = document.querySelector('.code-pnl ul');
						ul.style.top = -this.scrollTop + "px";
					});

					submit.addEventListener('click', function() {
						ctrl.submit(input.value);
					});

					refresh.addEventListener('click', function() {
						input.value = "";
						ctrl.onInputValueChange()
					});

					Array.prototype.contains = function(arr) {
						for(var i = 0; i < this.length; i++) { //this指向真正调用这个方法的对象  
							if(this[i] == arr) {
								return true;
							}
						}
						return false;
					}
				},
				"onInputValueChange": function() {
					var ul = document.querySelector('.code-pnl ul');
					var length = input.value.split("\n").length;
					var html = "<li>1</li>";
					for(var i = 1; i < length; i++) {
						html += "<li>" + (i + 1) + "</li>";
					}
					ul.innerHTML = html;
				},
				"submit": function(key) {
					var eventList = key.split("\n");
					var command = {};
					for(var i = 0; i < eventList.length; i++) {
						(function(i) {
							setTimeout(function() {
								// 判断是否为空
								if(eventList[i].replace(/^\s+|\s+$/g, "") == "") {
									return;
								}

								command.event = eventList[i].split(" ");
								command.step = parseInt(command.event.slice(-1), 10); // 取数组最后一个元素
								command.isSuccess = true;

								if(["TRA", "MOV"].contains(command.event[0]) && ["LEF", "TOP", "RIG", "BOT"].contains(command.event[1])) {
									command.key = command.event[0] + " " + command.event[1];
								} else if(command.event[0] == "TUN" && ["LEF", "RIG", "BAC"].contains(command.event[1])) {
									command.key = command.event[0] + " " + command.event[1];
								} else if(command.event[0] == "GO") {
									command.key = command.event[0];
								} else {
									command.isSuccess = false;
								}

								// 判断是否为整数
								if(command.step % 1 === 0) {
									command.isSuccess = false;
								}

								if(!command.isSuccess) {
									ctrl.error(i);
								} else {
									if(typeof(command.step) == "number" && command.step > 0) {
										ctrl.animate(command.key, command.step);
									} else {
										ctrl.animate(command.key);
									}
								}
							}, 210 * i);
						})(i);
					}
				},
				"animate": function(key, step) {
					if(!box.animateFlag) {
						box.animateFlag = true;
						setTimeout(function() {
							box.animateFlag = false;
						}, 200);
						switch(key) {
							case "GO": // 向前移动
								this.go(step);
								break;
							case "TUN LEF": // 方向 向左 旋转90deg
								this.tun("left");
								break;
							case "TUN RIG": // 方向 向右 旋转90deg
								this.tun("right");
								break;
							case "TUN BAC": // 方向 向后 旋转90deg
								this.tun("back");
								break;
							case "TRA LEF": // 向左移动
								this.tra("left", step);
								break;
							case "TRA TOP": // 向上移动
								this.tra("top", step);
								break;
							case "TRA RIG": // 向右移动
								this.tra("right", step);
								break;
							case "TRA BOT": // 向下移动
								this.tra("bottom", step);
								break;
							case "MOV LEF": // 向左移动，并旋转至左侧
								this.move("left", step);
								break;
							case "MOV TOP": // 向上移动，并旋转至上侧
								this.move("top", step);
								break;
							case "MOV RIG": // 向右移动，并旋转至右侧
								this.move("right", step);
								break
							case "MOV BOT": // 向下移动，并旋转至下侧
								this.move("bottom", step);
								break;
						}
					}
				},
				"error": function(i) {
					var errorLine = document.querySelectorAll('.code-pnl ul li');
					errorLine[i].classList.add("error");
				},
				"go": function(step) {
					var top = box.el.offsetTop;
					var left = box.el.offsetLeft;
					var flag = false;
					if(!step) {
						step = 1;
					}
					switch(box.direction) {
						case 3: // 向左移动
							left - 50 * step < 0 ? (flag = true) : (box.el.style.left = left - 50 * step + "px");
							break;
						case 0: // 向上移动
							top - 50 * step < 0 ? (flag = true) : (box.el.style.top = top - 50 * step + "px");
							break;
						case 1: // 向右移动
							left + 50 * step >= 500 ? (flag = true) : (box.el.style.left = left + 50 * step + "px");
							break;
						case 2: // 向下移动
							top + 50 * step >= 500 ? (flag = true) : (box.el.style.top = top + 50 * step + "px");
							break;
					}
					if(flag) {
						alert("碰到墙壁了")
					};
				},
				"tun": function(drct) {
					switch(drct) {
						case "left":
							box.direction - 1 < 0 ? box.direction = 3 : box.direction--;
							box.rotate -= 90;
							break;
						case "right":
							box.direction + 1 > 3 ? box.direction = 0 : box.direction++;
							box.rotate += 90;
							break;
						case "back":
							box.direction + 1 > 3 ? box.direction = 0 : box.direction++;
							box.direction + 1 > 3 ? box.direction = 0 : box.direction++;
							box.rotate += 180;
							break;
					}
					box.el.style.transform = "rotate(" + box.rotate + "deg)";
				},
				"tra": function(drct, step) {
					var top = box.el.offsetTop;
					var left = box.el.offsetLeft;
					var flag = false;
					if(!step) {
						step = 1;
					}
					switch(drct) {
						case "left":
							left - 50 * step < 0 ? (flag = true) : (box.el.style.left = left - 50 * step + "px");
							break;
						case "top":
							top - 50 * step < 0 ? (flag = true) : (box.el.style.top = top - 50 * step + "px");
							break;
						case "right":
							left + 50 * step >= 500 ? (flag = true) : (box.el.style.left = left + 50 * step + "px");
							break;
						case "bottom":
							top + 50 * step >= 500 ? (flag = true) : (box.el.style.top = top + 50 * step + "px");
							break;
					}
					if(flag) {
						alert("碰到墙壁了")
					};
				},
				"move": function(drct, step) {
					// 改变方向
					switch(drct) {
						case "left":
							switch(box.direction) {
								case 0:
									box.rotate -= 90;
									break;
								case 1:
									box.rotate -= 180;
									break;
								case 2:
									box.rotate += 90;
									break;
							}
							box.direction = 3;
							break;
						case "top":
							switch(box.direction) {
								case 1:
									box.rotate -= 90;
									break;
								case 2:
									box.rotate -= 180;
									break;
								case 3:
									box.rotate += 90;
									break;
							}
							box.direction = 0;
							break;
						case "right":
							switch(box.direction) {
								case 0:
									box.rotate += 90;
									break;
								case 2:
									box.rotate -= 90;
									break;
								case 3:
									box.rotate -= 180;
									break;
							}
							box.direction = 1;
							break;
						case "bottom":
							switch(box.direction) {
								case 0:
									box.rotate -= 180;
									break;
								case 1:
									box.rotate += 90;
									break;
								case 3:
									box.rotate -= 90;
									break;
							}
							box.direction = 2;
							break;
					}
					// 旋转角度
					box.el.style.transform = "rotate(" + box.rotate + "deg)";
					// 移动
					this.tra(drct, step);
				}
			}
			ctrl.init();
		}
	</script>

</html>